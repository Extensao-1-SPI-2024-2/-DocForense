{% extends "base.html" %}

{% block title %}Listagem de Chamados{% endblock %}
{% block maintitle %}Listagem de Chamados{% endblock %}

{% block breadcrumb %}
  <li class="breadcrumb-item"><a href="#">Chamados</a></li>
  <li class="breadcrumb-item active" aria-current="page">Listagem</li>
{% endblock %}

{% block content %}
  <div class="card py-3 px-2 bg-white">
    <div class="p-2">
      <h5>Listagem</h5>
    </div>
    <div class="card-body">
      {% if not is_super_user %}
        <div class="text-end">
          <a href="/chamado/criar"><button class="btn btn-primary"><i class="fas fa-plus"></i> Cadastrar</button></a>
        </div>
      {% endif %}

      <table id="listagem" class="table table-striped table-bordered" style="width:100%">
        <thead>
          <tr>
            <th>Assunto</th>
            <th>Aguardando</th>
            <th>Status</th>
            <th>Urgência</th>
            <th>Usuário</th>
            <th>Inclusão</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for chamado in chamados %}
            <tr>
              <td>{{ chamado.assunto }}</td>
              <td>
                {% if chamado.responsavel == 1 %}
                  Solicitante
                {% else %}
                  Administração
                {% endif %}
              </td>
              <td>
                {% if chamado.status == 1 %}
                    <span class="badge text-bg-primary" style="font-size: 0.9rem;">{{ chamado.get_status_display }}</span>
                {% else %}
                    <span class="badge text-bg-secondary" style="font-size: 0.9rem;">{{ chamado.get_status_display }}</span>
                {% endif %}
              </td>
              <td>
                {% if chamado.urgencia == 1 %}
                    <span class="badge text-bg-info text-white" style="font-size: 0.9rem;">{{ chamado.get_urgencia_display }}</span>
                {% elif chamado.urgencia == 2 %}
                    <span class="badge text-bg-warning text-white" style="font-size: 0.9rem;">{{ chamado.get_urgencia_display }}</span>
                {% else %}
                    <span class="badge text-bg-danger" style="font-size: 0.9rem;">{{ chamado.get_urgencia_display }}</span>
                {% endif %}
              </td>
              <td>{{ chamado.user_inclusion.first_name }} {{ chamado.user_inclusion.last_name }}</td>
              <td>{{ chamado.date_inclusion|date:'d/m/Y H:i' }}</td>
              <td class="is-narrow">
                <div class="text-end">
                    <a href="/chamado/{{ chamado.id }}"><button class="btn btn-warning text-white btn-sm"><i class="fas fa-microscope"></i></button></a>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>
  <script>
    $(document).ready(function () {
      $('#listagem').DataTable({
        // Opções de personalização
        paging: true, // Habilita paginação
        searching: false, // Habilita barra de pesquisa
        info: true, // Exibe informações como "Mostrando X de Y"
        lengthChange: true, // Permite alterar o número de linhas exibidas
        pageLength: 10, // Define o número padrão de linhas por página
        language: {
          url: "https://cdn.datatables.net/plug-ins/1.13.5/i18n/pt-BR.json"
        }
      })
    })

    document.addEventListener("DOMContentLoaded", function() {
        var confirmDeleteModal = document.getElementById('confirmDeleteModal');
        var confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        confirmDeleteModal.addEventListener('show.bs.modal', function(event) {
            var button = event.relatedTarget; // Botão que acionou o modal
            var deleteUrl = button.getAttribute('data-url'); // Pega o link do botão

            confirmDeleteBtn.setAttribute('href', deleteUrl); // Atualiza o botão de exclusão
        });
    });
  </script>
{% endblock %}
